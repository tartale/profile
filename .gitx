#!/bin/bash

git config --global user.email "tartale.work@gmail.com"
git config --global user.name "Tom"

export MYGITHUB="git@github.com:tartale"
export GITHUB="git@github.com:aspenmesh"

function gdefault() (
  defaultBranch="${GIT_DEFAULT_BRANCH:-main}"
  echo "${defaultBranch}"
)

function gremote() (
  defaultRemote="upstream"
  git remote | grep upstream > /dev/null 2>&1
  exists="$?"
  if [[ ${exists} == 1 ]]; then
    defaultRemote="origin"
  fi

  echo "${defaultRemote}"
)

function gsquash() (
  if [[ "${1}" == "" ]] || [[ "${2}" == "" ]]
  then
    echo "usage: gsquash <numCommits> <message>"
    return 1
  fi
  git reset --soft "HEAD~${1}" && git commit -vm "${2}"
)

function gclone {
  if [ -z $1 ]
  then
    echo "usage:  gclone <repository>"
    exit
  fi

  (cd $PROJECTS
    git clone $MYGITHUB/$1.git
    (
      cd $1
      git remote add upstream $GITHUB/$1.git
      git fetch upstream
    )
  )
}

function gfinish {
  if [ -z $1 ]
  then
    echo "usage:  gfinish <branch>"
    return
  fi
  branch="${1}"

  git checkout $(gdefault)
  git pull upstream $(gdefault)
  git branch -D ${branch}
}

function gcurse() {
  gitDirs=$(find . -type d -maxdepth 2 -exec test -e {}/.git \; -print)
  for dir in ${gitDirs[@]}; do
    (
      echo "${dir}"
      cd "${dir}"
      exec "${@}"
    )
  done
}

source "${PROJECTS}/profile/.git-completion.sh"
__git_complete gfinish _git_checkout
__git_complete gck _git_checkout
__git_complete gb _git_branch

if [ -e "${PROJECTS}/profile/.gitx-aspenmesh" ]
then
    source "${PROJECTS}/profile/.gitx-aspenmesh"
fi
